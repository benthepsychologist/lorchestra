aip_id: AIP-lorchestra-2025-11-21-001
context:
  background: "We have a Meltano project at `/workspace/ingestor` with 11+ taps (Gmail, Exchange, Dataverse,\
    \ Stripe, etc.) and custom Singer targets (target-event-emitter, target-jsonl-chunked) that directly\
    \ emit to BigQuery.\n\n**Problem:** This violates separation of concerns:\n- Meltano/Singer shouldn't\
    \ know about events or BigQuery\n- Event emission should happen at the orchestrator layer (lorc)\n\
    - We need clean boundaries for 15+ API sources\n\n**Solution:** Three-layer architecture with clear\
    \ contracts:\n\n```\n┌─────────────────────────────────────────────────┐\n│  lorc (orchestrator +\
    \ event boundary)          │\n│  - Defines jobs (job_ingest_gmail, etc.)        │\n│  - Calls ingestor\
    \ to get JSONL                  │\n│  - Reads JSONL, computes idem_key               │\n│  - Calls\
    \ event_client.emit()                    │\n└──────────────────┬──────────────────────────────┘\n\
    \                   │ (calls)\n┌──────────────────▼──────────────────────────────┐\n│  ingestor (thin\
    \ Meltano wrapper)                │\n│  - Runs: meltano run tap-x target-jsonl         │\n│  - Returns:\
    \ Path to JSONL file                  │\n│  - NO event knowledge, NO BigQuery              │\n└──────────────────┬──────────────────────────────┘\n\
    \                   │ (raw JSONL)\n                   ▼\n          /tmp/phi-vault/jsonl-tmp/{run_id}.jsonl\n\
    \                   │\n                   │ (read by lorc)\n                   ▼\n┌─────────────────────────────────────────────────┐\n\
    │  event_client (event spine gateway)             │\n│  - INSERT into event_log (audit trail)    \
    \      │\n│  - MERGE into raw_objects (dedup by idem_key)   │\n│  - Lives in lorc/stack_clients/ \
    \                │\n└─────────────────────────────────────────────────┘\n```"
  constraints:
  - No custom Meltano targets (use standard target-jsonl only)
  - All event emission must happen in lorc, never in ingestor
  - ingestor must be domain-agnostic (just Meltano → JSONL)
  - event_client is the single gateway to BigQuery
created: '2025-11-19T21:40:35.577860+00:00'
meta:
  created_at: '2025-11-19T21:40:35.577860+00:00'
  created_by: benthepsychologist
objective:
  acceptance_criteria:
  - event_client implements two-table pattern (event_log + raw_objects) ✓
  - ingestor package wraps Meltano with clean API (returns JSONL paths)
  - lorc jobs call ingestor and emit events via event_client
  - Custom targets deleted (target-event-emitter, target-jsonl-chunked)
  - Standard target-jsonl used for all Meltano runs
  - End-to-end test passes (Meltano → JSONL → events → BQ)
  - Idempotency verified (re-run produces no duplicate objects)
  - All tests passing
  goal: Implement clean three-layer ingestion architecture with event_log + raw_objects
orchestrator_contract:
  artifacts_dir: .aip_artifacts/AIP-lorchestra-2025-11-21-001
  logging: jsonl
  state_machine:
    events:
    - run_step
    - await_gate
    - approve
    - reject
    - retry
    - escalate
    - complete
    states:
    - pending
    - running
    - awaiting_human
    - failed
    - succeeded
    - rolled_back
plan:
- description: Create ingestor Package (Meltano Wrapper)
  gate_ref: 'G0: Plan Approval'
  kind: code
  outputs:
  - ingestor/__init__.py
  - ingestor/extractors.py
  - pyproject.toml
  role: coding_agent
  step_id: step-001
- description: Create lorc Ingestion Jobs
  gate_ref: 'G1: Code Readiness'
  kind: code
  outputs:
  - lorchestra/jobs/__init__.py
  - lorchestra/jobs/ingest_gmail.py
  role: coding_agent
  step_id: step-002
- description: Configure Meltano for Standard target-jsonl
  gate_ref: 'G2: Pre-Release'
  kind: code
  role: coding_agent
  step_id: step-003
- description: BigQuery Setup (Tables and Credentials)
  gate_ref: 'G3: Pre-Release'
  kind: manual
  outputs:
  - event_log table created
  - raw_objects table created
  - service account credentials configured
  role: human
  step_id: step-004
- description: Testing & Validation
  gate_ref: 'G4: Pre-Release'
  kind: code
  role: coding_agent
  step_id: step-005
- description: Documentation & Finalization
  gate_ref: 'G5: Final Approval'
  kind: code
  role: coding_agent
  step_id: step-006
project_slug: lorchestra
repo:
  default_branch: main
  url: git@github.com:benthepsychologist/lorchestra.git
  working_branch: feat/ingestion-to-bq
spec_version: 1.0.0
tier: C
title: Clean ingestor → lorc → event_client pipeline
updated: '2025-11-19T22:30:00+00:00'
version: '0.1'

