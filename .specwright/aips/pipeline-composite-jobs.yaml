aip_id: AIP-lorchestra-2025-12-11-001
context:
  background: ''
  constraints: []
created: '2025-12-11T00:00:00+00:00'
meta:
  created_at: '2025-12-11T00:00:00+00:00'
  created_by: benthepsychologist
objective:
  acceptance_criteria:
  - '`pipeline.ingest` runs all ingestion + validation jobs'
  - '`pipeline.canonize` runs all canonization jobs'
  - '`pipeline.formation` runs measurement events + observations jobs'
  - '`pipeline.project` runs BQ sync + file projection jobs'
  - '`pipeline.views` runs all view creation jobs'
  - '`pipeline.daily_all` runs full pipeline in sequence'
  - All composite jobs return structured result (see schema below)
  - 'Phase composites: `success = (failed == 0)` but always run all children'
  - '`pipeline.daily_all`: stops on first failed phase, returns phase that failed'
  - Bash scripts in `life-cockpit/scripts/` marked deprecated with comment pointing to composites
  - Job lists maintained in ONE place only (lorchestra composite definitions)
  - After composites are validated, bash scripts are frozen legacy shims - they will NOT receive new jobs
  goal: Define composite jobs that group atomic pipeline steps into single orchestration units
orchestrator_contract:
  artifacts_dir: .aip_artifacts/AIP-lorchestra-2025-12-11-001
  logging: jsonl
  state_machine:
    events:
    - run_step
    - await_gate
    - approve
    - reject
    - retry
    - escalate
    - complete
    states:
    - pending
    - running
    - awaiting_human
    - failed
    - succeeded
    - rolled_back
plan:
- description: Define pipeline.ingest Composite
  gate_ref: 'G0: Code Review'
  kind: code
  prompt: 'Create composite job `pipeline.ingest` that runs all jobs from `daily_ingest.sh`:

    **Stage 1 - Ingestion (parallelizable):**

    - Gmail: `ingest_gmail_acct1`, `ingest_gmail_acct2`, `ingest_gmail_acct3`

    - Exchange: `ingest_exchange_ben_mensio`, `ingest_exchange_booking_mensio`, `ingest_exchange_info_mensio`

    - Dataverse: `ingest_dataverse_contacts`, `ingest_dataverse_sessions`, `ingest_dataverse_reports`

    - Stripe: `ingest_stripe_customers`, `ingest_stripe_invoices`, `ingest_stripe_payment_intents`, `ingest_stripe_refunds`

    - Google Forms: `ingest_google_forms_intake_01`, `ingest_google_forms_intake_02`, `ingest_google_forms_followup`,
    `ingest_google_forms_ipip120`

    **Stage 2 - Validation (after all ingestion completes):**

    - `validate_gmail`, `validate_exchange`, `validate_google_forms`

    - `validate_dataverse_contacts`, `validate_dataverse_sessions`, `validate_dataverse_reports`

    - `validate_stripe_customers`, `validate_stripe_invoices`, `validate_stripe_payment_intents`, `validate_stripe_refunds`

    Must return structured result per schema.'
  role: coding_agent
  step_id: step-001
- description: Define pipeline.canonize Composite
  gate_ref: 'G0: Code Review'
  kind: code
  prompt: 'Create composite job `pipeline.canonize` that runs all jobs from `daily_canonize.sh`:

    **All parallelizable:**

    - Email: `canonize_gmail_jmap`, `canonize_exchange_jmap`

    - Dataverse: `canonize_dataverse_contacts`, `canonize_dataverse_sessions_clinical`, `canonize_dataverse_sessions_transcripts`,
    `canonize_dataverse_sessions_notes`, `canonize_dataverse_sessions_summaries`, `canonize_dataverse_reports`

    - Stripe: `canonize_stripe_customers`, `canonize_stripe_invoices`, `canonize_stripe_payments`, `canonize_stripe_refunds`

    - Forms: `canonize_google_forms`

    Must return structured result per schema.'
  role: coding_agent
  step_id: step-002
- description: Define pipeline.formation Composite
  gate_ref: 'G0: Code Review'
  kind: code
  prompt: 'Create composite job `pipeline.formation` that runs all jobs from `daily_formation.sh`:

    **Stage 1 - Measurement Events (parallelizable):**

    - `proj_me_intake_01`, `proj_me_intake_02`, `proj_me_followup`

    **Stage 2 - Observations (after ME completes, parallelizable):**

    - `proj_obs_intake_01`, `proj_obs_intake_02`, `proj_obs_followup`

    Must return structured result per schema.'
  role: coding_agent
  step_id: step-003
- description: Define pipeline.project Composite
  gate_ref: 'G0: Code Review'
  kind: code
  prompt: 'Create composite job `pipeline.project` that runs all jobs from `daily_local_projection.sh`:

    **Stage 1 - BQ → SQLite Sync (parallelizable):**

    - `sync_proj_clients`, `sync_proj_sessions`, `sync_proj_transcripts`

    - `sync_proj_clinical_documents`, `sync_proj_form_responses`, `sync_proj_contact_events`

    - `sync_measurement_events`, `sync_observations`

    **Stage 2 - SQLite → Markdown Files (after sync completes, parallelizable):**

    - `file_proj_clients`, `file_proj_transcripts`

    - `file_proj_session_notes`, `file_proj_session_summaries`, `file_proj_reports`

    Must return structured result per schema.'
  role: coding_agent
  step_id: step-004
- description: Define pipeline.views Composite
  gate_ref: 'G0: Code Review'
  kind: code
  prompt: 'Create composite job `pipeline.views` that runs all jobs from `create_views.sh`:

    **All parallelizable:**

    - `view_proj_clients`, `view_proj_sessions`, `view_proj_transcripts`

    - `view_proj_clinical_documents`, `view_proj_form_responses`, `view_proj_contact_events`

    Must return structured result per schema.'
  role: coding_agent
  step_id: step-005
- description: Define pipeline.daily_all Composite
  gate_ref: 'G0: Code Review'
  kind: code
  prompt: 'Create composite job `pipeline.daily_all` that runs the full daily pipeline:

    **Strictly sequential, stop on failure:**

    1. `pipeline.ingest` → if failed, stop and return

    2. `pipeline.canonize` → if failed, stop and return

    3. `pipeline.formation` → if failed, stop and return

    4. `pipeline.project` → if failed, stop and return

    (Note: `pipeline.views` is NOT included - it''s a one-time setup, not daily)

    Must return extended result schema (see Result Schema section above).'
  role: coding_agent
  step_id: step-006
- description: Deprecate Bash Scripts
  gate_ref: 'G1: Code Review'
  kind: code
  outputs:
  - life-cockpit/scripts/daily_ingest.sh
  - life-cockpit/scripts/daily_canonize.sh
  - life-cockpit/scripts/daily_formation.sh
  - life-cockpit/scripts/daily_local_projection.sh
  - life-cockpit/scripts/create_views.sh
  prompt: 'Add deprecation notice to each script in `life-cockpit/scripts/`:

    ```bash

    #!/bin/bash

    # DEPRECATED: This script is replaced by lorchestra composite jobs.

    # Use: lorchestra run pipeline.ingest

    # Or:  life pipeline ingest (after life-cli integration)

    #

    # This script will be removed in a future release.

    # See: /workspace/lorchestra/.specwright/specs/pipeline-composite-jobs.md

    ```

    Do NOT update the job lists in these scripts. The composite jobs are now the source of truth.'
  role: coding_agent
  step_id: step-007
- description: Add Snapshot Tests
  gate_ref: 'G1: Pre-Release'
  kind: code
  outputs:
  - tests/test_pipeline_composites.py
  prompt: "Create tests that verify composite job child lists match expectations:\n```python\ndef test_pipeline_ingest_child_jobs():\n\
    \    \"\"\"Ensure pipeline.ingest includes all expected child jobs.\"\"\"\n    expected = {\n    \
    \    \"ingest_gmail_acct1\", \"ingest_gmail_acct2\", \"ingest_gmail_acct3\",\n        \"ingest_exchange_ben_mensio\"\
    , \"ingest_exchange_booking_mensio\", \"ingest_exchange_info_mensio\",\n        \"ingest_dataverse_contacts\"\
    , \"ingest_dataverse_sessions\", \"ingest_dataverse_reports\",\n        \"ingest_stripe_customers\"\
    , \"ingest_stripe_invoices\", \"ingest_stripe_payment_intents\", \"ingest_stripe_refunds\",\n    \
    \    \"ingest_google_forms_intake_01\", \"ingest_google_forms_intake_02\", \"ingest_google_forms_followup\"\
    , \"ingest_google_forms_ipip120\",\n        \"validate_gmail\", \"validate_exchange\", \"validate_google_forms\"\
    ,\n        \"validate_dataverse_contacts\", \"validate_dataverse_sessions\", \"validate_dataverse_reports\"\
    ,\n        \"validate_stripe_customers\", \"validate_stripe_invoices\", \"validate_stripe_payment_intents\"\
    , \"validate_stripe_refunds\",\n    }\n    actual = get_composite_child_jobs(\"pipeline.ingest\")\n\
    \    assert actual == expected, f\"Missing: {expected - actual}, Extra: {actual - expected}\"\ndef\
    \ get_composite_child_jobs(composite_id: str) -> set[str]:\n    \"\"\"Test helper: Parse pipeline.yaml\
    \ and return child job IDs for a composite.\n    This is a test utility, not a production API. It\
    \ parses the YAML definition\n    directly to extract the list of child jobs.\n    \"\"\"\n    # Implementation:\
    \ load YAML, extract job list from composite definition\n    ...\n```\nSimilar tests for all composites.\n\
    This prevents accidentally dropping jobs when refactoring."
  role: coding_agent
  step_id: step-008
- description: Integration Test
  gate_ref: 'G2: Pre-Release'
  kind: code
  prompt: 'Test each composite job in dry-run mode:

    ```bash

    lorchestra run pipeline.ingest --dry-run

    lorchestra run pipeline.canonize --dry-run

    lorchestra run pipeline.formation --dry-run

    lorchestra run pipeline.project --dry-run

    lorchestra run pipeline.views --dry-run

    lorchestra run pipeline.daily_all --dry-run

    ```

    Verify:

    - All internal jobs are listed

    - Order is correct (stages respected)

    - Result schema is returned

    - No missing jobs compared to bash scripts'
  role: coding_agent
  step_id: step-009
project_slug: lorchestra
repo:
  default_branch: main
  url: git@github.com:benthepsychologist/lorchestra.git
  working_branch: feat/pipeline-composites
spec_version: 1.0.0
tier: C
title: Add Pipeline Composite Jobs
updated: '2025-12-11T00:00:00+00:00'
version: '0.1'

