job_id: canonize_dataverse_contacts
version: '2.0'
steps:
- step_id: read
  op: storacle.query
  params:
    dataset: raw
    table: raw_objects
    columns:
    - idem_key
    - source_system
    - connection_name
    - object_type
    - payload
    - correlation_id
    filters:
      source_system: dataverse
      object_type: contact
    parse_json_columns:
    - payload
    limit: 100
    incremental:
      target_dataset: canonical
      target_table: canonical_objects
      source_key: idem_key
      target_key: idem_key
      join_key_suffix: contact
      mode: left_anti
- step_id: canonize
  op: call
  params:
    callable: canonizer
    source_type: dataverse
    items: '@run.read.items'
    config:
      transform_id: contact/dataverse_to_canonical@2-0-0
- step_id: persist
  op: plan.build
  params:
    items: '@run.canonize.items'
    method: bq.upsert
    dataset: canonical
    table: canonical_objects
    key_columns:
    - idem_key
    idem_key_suffix: contact
    auto_timestamp_columns:
    - canonicalized_at
    - created_at
    field_defaults:
      canonical_schema: iglu:org.canonical/contact/jsonschema/2-0-0
      canonical_format: contact
      transform_ref: contact/dataverse_to_canonical@2-0-0
    fields:
    - idem_key
    - source_system
    - connection_name
    - object_type
    - canonical_schema
    - canonical_format
    - transform_ref
    - correlation_id
    - payload
    - canonicalized_at
    - created_at
    skip_update_columns:
    - created_at
- step_id: write
  op: storacle.submit
  params:
    plan: '@run.persist.plan'
